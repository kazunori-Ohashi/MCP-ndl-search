import { Prompt } from '@modelcontextprotocol/sdk/types.js';

export const ndlQualityControlPrompt: Prompt = {
  name: 'ndl_quality_control',
  description: 'NDL search quality control and result optimization strategies',
  arguments: [
    {
      name: 'quality_aspect',
      description: 'Quality control aspect (result_validation, irrelevant_handling, refinement_strategy, japanese_specifics)',
      required: false
    }
  ]
};

export function generateNDLQualityControl(qualityAspect?: string): string {
  const qualityGuide = `
# NDL検索品質管理 - 実践的評価・改善ガイド

## 🎯 検索品質の基本原則

### 品質評価の3つの観点
1. **関連性 (Relevance)**: 検索意図との一致度
2. **網羅性 (Coverage)**: 重要文献の取りこぼし率  
3. **精度 (Precision)**: 無関係結果の混入率

### Description検索中心の品質管理
**Description検索が主軸となる理由を品質面から解説**:
- ✅ **高い内容関連性**: タイトルでは判断できない内容的関連性
- ✅ **網羅性の確保**: タイトルに現れない関連文献も発見
- ✅ **学術研究適合**: 研究テーマから直接的な文献発見
- ⚠️ **キーワード依存**: 品質はキーワード選択に大きく依存

## 検索結果の妥当性評価方法

### レベル1: 即座判定（3秒評価）
検索実行直後の簡速評価:
\`\`\`
✅ 優良: タイトルを見ただけで関連性が明確
🔍 要確認: タイトルだけでは判断困難
❌ 無関係: 明らかに検索意図と乖離
\`\`\`

### レベル2: 内容確認（30秒評価）
結果詳細の関連性チェック:
\`\`\`
確認項目:
- 著者の専門分野
- 出版年（研究の新しさ）
- 出版社（学術性の指標）
- 抄録・要約の内容
\`\`\`

### レベル3: 学術価値評価（深度評価）
学術研究での価値判定:
\`\`\`
評価基準:
- 一次資料 vs 二次資料
- 学術出版 vs 一般出版
- 専門研究 vs 入門書
- 最新性 vs 古典的価値
\`\`\`

### 品質スコアリングシステム
\`\`\`
10点: 完全一致（求めていた内容そのもの）
8-9点: 高関連（直接的に有用）
6-7点: 中関連（参考価値あり）
4-5点: 低関連（一部のみ有用）
1-3点: 微関連（ほぼ無関係）
0点: 無関係（完全に場違い）
\`\`\`

## 無関係な結果が多い場合の対処法

### 診断1: 結果パターンの分析
\`\`\`
症状: 大量ヒット（50件以上）
原因: キーワードが一般的すぎる
対処: より具体的なキーワードに変更

症状: 分野違いの結果混在
原因: 多義語の使用
対処: 分野限定キーワード追加

症状: 時代・地域の不一致
原因: 範囲指定の不足  
対処: 時代・地域キーワード追加
\`\`\`

### 対処法1: キーワード特化
**Before**: \`description="経済"\` (広すぎる)
**After**: \`description="経済史" AND title="明治"\` (特化)

**Before**: \`description="文化"\` (曖昧)
**After**: \`description="茶道文化" AND title="歴史"\` (具体化)

### 対処法2: AND条件での絞り込み
\`\`\`
段階的絞り込み例:
Step 1: description="仏教" (1000件) 
Step 2: description="仏教" AND title="日本" (300件)
Step 3: description="仏教" AND title="日本" AND subject="宗教史" (50件)
\`\`\`

### 対処法3: 無関係パターンの除外
\`\`\`
無関係パターン認識:
- 同音異義語による誤ヒット
- 関連性の薄い包括的著作
- 時代・地域の不一致
- 学術レベルの不適合
\`\`\`

## 検索語の調整とリファインメント戦略

### 戦略1: 段階的具体化
\`\`\`
Level 1 (広域): description="歴史"
Level 2 (中域): description="日本史"  
Level 3 (狭域): description="古代史" AND title="飛鳥"
Level 4 (特定): description="古代史" AND title="飛鳥" AND subject="聖徳太子"
\`\`\`

### 戦略2: キーワード軸の変更
\`\`\`
軸1 (分野): description="経済" → description="経済史"
軸2 (手法): description="研究" → description="分析"  
軸3 (対象): description="文化" → description="文化史"
軸4 (時代): title="近世" → title="江戸"
\`\`\`

### 戦略3: 組み合わせ最適化
\`\`\`
パターンA: description主体
description="テーマ" AND title="限定語"

パターンB: subject主体  
subject="分野" AND description="観点"

パターンC: 複合条件
description="手法" AND title="対象" AND subject="分類"
\`\`\`

### 戦略4: フィードバックループ
\`\`\`
1. 初期検索実行
2. 結果品質評価（上位5件）
3. 関連性パターン分析
4. キーワード調整決定
5. 再検索・評価
6. 満足度に達するまで反復
\`\`\`

## 日本語検索特有の注意点

### 文字種の考慮
\`\`\`
ひらがな: 一般的概念、感情表現
カタカナ: 外来語、専門用語
漢字: 学術用語、固有名詞

推奨: 漢字での学術用語検索
例: "けんきゅう" → "研究"
\`\`\`

### 同音異義語の対策
\`\`\`
問題例: "こうか" 
- 効果、硬化、高価、皇家、光化...

対策: 文脈限定キーワード追加
"効果" AND "研究" → 研究効果
"硬化" AND "材料" → 材料硬化
\`\`\`

### 古典・現代表記の統一
\`\`\`
古典: 旧字体、歴史的仮名遣い
現代: 新字体、現代仮名遣い

検索時: 現代標準表記を使用
例: "國史" → "国史"
    "佛教" → "仏教"
\`\`\`

### 敬語・丁寧語の回避
\`\`\`
❌ "調べています"、"研究されている"
✅ "調査"、"研究"

学術検索では名詞形の客観的表現を使用
\`\`\`

## 品質改善の実践例

### 改善例1: 人物研究
**初期**: \`title="聖徳太子"\` (3,000件、多くは無関係)
**改善**: \`description="伝記" AND title="聖徳太子"\` (3件、高関連性)
**効果**: 99%の無関係結果除去

### 改善例2: 経済研究  
**初期**: \`description="経済"\` (50,000件、分散)
**改善**: \`description="経済史" AND title="明治"\` (150件、特定時代)
**効果**: 時代特定による精度向上

### 改善例3: 文化研究
**初期**: \`subject="文化"\` (10,000件、広範囲)
**改善**: \`description="茶道" AND subject="文化史"\` (80件、特定文化)
**効果**: 特定文化領域への集約

## 継続的品質向上のチェックリスト

### 検索前チェック
- [ ] 検索目的の明確化
- [ ] 適切なキーワード選択
- [ ] Description検索優先の確認
- [ ] maxRecords設定（初回3-5件）

### 検索後チェック  
- [ ] 上位結果の関連性確認
- [ ] 無関係結果の比率評価
- [ ] 重要文献の取りこぼし確認
- [ ] キーワード調整の必要性判断

### 改善実行チェック
- [ ] より具体的キーワードへの変更
- [ ] AND条件による絞り込み
- [ ] 異なる検索軸での再試行
- [ ] 結果品質の再評価

## 品質管理のKPI設定

### 定量指標
- **関連率**: 関連結果数 / 総結果数 × 100%
- **発見率**: 発見文献数 / 期待文献数 × 100%  
- **効率度**: 有用結果数 / 検索実行回数

### 定性指標  
- 検索意図との一致度
- 学術的価値の適合度
- 研究目的への貢献度

### 目標値設定
- 関連率: 80%以上
- 発見率: 70%以上
- 効率度: 検索3回以内で満足結果
`;

  const specificAspects: Record<string, string> = {
    result_validation: `
# 検索結果検証の詳細プロセス

## 3段階検証システム

### 第1段階: タイトル検証（5秒）
- タイトルキーワードの関連性
- 明らかな無関係結果の除外
- 有望候補の特定

### 第2段階: メタデータ検証（30秒）  
- 著者の専門性確認
- 出版年の適切性
- 出版社の学術性

### 第3段階: 内容検証（3分）
- 抄録・要約の詳細確認  
- 研究手法の適合性
- 一次/二次資料の判別
`,

    irrelevant_handling: `
# 無関係結果対処の具体的手順

## パターン別対処法

### パターン1: 同音異義語による誤ヒット
**対処**: 文脈キーワード追加
**例**: "効果" → "効果" AND "研究"

### パターン2: 過度に広範な結果
**対処**: 段階的絞り込み
**例**: "文化" → "茶道文化" → "茶道文化史"

### パターン3: 時代・地域の不一致
**対処**: 時空間限定キーワード
**例**: "経済" → "経済" AND "明治"
`,

    refinement_strategy: `
# リファインメント戦略の詳細

## 4つのリファインメント軸

### 軸1: 概念の具体化
一般概念 → 専門概念 → 特定概念

### 軸2: 範囲の限定  
全領域 → 分野限定 → テーマ特定

### 軸3: 手法の明確化
曖昧手法 → 明確手法 → 特定手法

### 軸4: 時空間の限定
全時代 → 時代限定 → 期間特定
`,

    japanese_specifics: `
# 日本語検索の特殊対応

## 文字種最適化戦略
- **漢字優先**: 学術的概念
- **カタカナ**: 外来専門用語  
- **ひらがな**: 助詞・接続語

## 表記揺れ対応
- 旧字体 → 新字体統一
- 異体字 → 標準字体統一
- 送り仮名 → 標準形統一

## 語彙レベル調整
- 口語 → 文語変換
- 敬語 → 平叙文変換
- 方言 → 標準語変換
`
  };

  if (qualityAspect && specificAspects[qualityAspect]) {
    return qualityGuide + '\n\n' + specificAspects[qualityAspect];
  }

  return qualityGuide;
}